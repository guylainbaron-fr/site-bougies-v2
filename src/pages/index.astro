---
export const prerender = false;

import MainLayout from '../layouts/MainLayout.astro';
import { Image } from 'astro:assets';
import { createClient } from '@vercel/kv';

// --- DONNÉES DE BASE ---
let userIP = "Privé";
let detectedDevice = "PC";
const forwarded = Astro.request.headers.get("x-forwarded-for");
if (forwarded) userIP = forwarded.split(',')[0].trim();
const ua = Astro.request.headers.get("user-agent") || "";
if (/android/i.test(ua)) detectedDevice = "Android";
else if (/iPad|iPhone|iPod/i.test(ua)) detectedDevice = "iOS";
const isQR = Astro.url.searchParams.get('ref') === 'qr';

// --- 2. FONCTIONS GÉO-IP ---
async function getCountryData(ip: string) {
    if (!ip || ip === "::1" || ip === "127.0.0.1" || ip === "Privé" || ip === "Prive") {
        return { country: "France", code: "FR" };
    }

    try {
        const response = await fetch(`http://ip-api.com/json/${ip}`, {
            signal: AbortSignal.timeout(3000) 
        });
        
        const data = await response.json();

        if (data && data.status === 'success') {
            return { 
                country: data.country || "France", 
                code: data.countryCode || "FR" 
            };
        }
    } catch (e) {
        console.error("Erreur géo-IP:", e);
    }
    return { country: "France", code: "FR" };
}

// --- LOGIQUE KV ---
const KV_URL = process.env.KV_REST_API_URL || import.meta.env.KV_REST_API_URL || '';
const KV_TOKEN = process.env.KV_REST_API_TOKEN || import.meta.env.KV_REST_API_TOKEN || '';
if (KV_URL && KV_TOKEN && !Astro.url.pathname.includes('admin')) {
    try {
        const kv = createClient({ url: KV_URL, token: KV_TOKEN });
        const geo = await getCountryData(userIP);
        const logEntry = {
            date: new Date().toLocaleString('fr-FR', { timeZone: 'Europe/Paris' }),
            device: detectedDevice,
            isQR: isQR,
            ip: userIP,
            country: geo.country,
            flag_code: (geo.code || "FR").toLowerCase()
        };
        await kv.incr('visites_totales');
        await kv.lpush('journal_visites', JSON.stringify(logEntry));
        await kv.ltrim('journal_visites', 0, 99);
    } catch (e) {}
}

import heroHome from "../assets/images/hero-home.webp";
import accueilImg from "../assets/images/accueil-h2-1.webp";
import atelierImg from "../assets/images/accueil-h2-2.webp";
import aproposImg from "../assets/images/accueil-h2-3.webp";

// Tes textes exacts mis en variables pour éviter l'erreur de guillemets
const siteTitle = "Jean François & ANIUTA Artisans Sculpteurs Lozère 48";
const siteDesc = "Artisanat du bois et de la bougie de J.F. et Aniuta. Sculptures sur bois local et bougies naturelles à Chasseradès.";
const msgHolidays = "Que l'année 2026 s'illumine de mille feux... Meilleurs Voeux !";

const schemaData = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": "Jean-François & Aniuta",
  "description": siteDesc,
  "url": "https://jf-aniuta.vercel.app/"
});
---

<MainLayout title={siteTitle} description={siteDesc} holidayMessage={msgHolidays}>
    <script type="application/ld+json" slot="head" set:html={schemaData}></script>

    <section id="hero">
        <Image src={heroHome} alt="Scènes d'atelier de sculptures et bougies" class="hero-background-image" loading="eager" width={1435} height={708} />
        <div class="container">
            <h1>L'Héritage Lozérien : Maîtres Sculpteurs et Créateurs de Bougies Artisanales.</h1> 
            <p>Chaleur du bois sculpté, réconfort de la flamme parfumée. L'artisanat conçu pour enrichir votre intérieur.</p>
            <a href="/bougies" class="btn large-btn"> Découvrir l'univers</a>
        </div>
    </section>

    <section id="accueil">
        <div class="container">
            <div class="section-top-image"><Image src={accueilImg} alt="Art du bois" width={600} height={669} /></div>
            <h2>L'Art du Bois et le Parfum des Sens.</h2>              
            <p>Découvrez l'harmonie parfaite entre la chaleur du bois sculpté et les senteurs envoûtantes de nos créations artisanales. Chaque pièce raconte une histoire de passion et de nature.</p>
            <a href="/bougies" class="btn">Découvrir les Bougies</a> 
        </div>
    </section>

    <section id="atelier">
        <div class="container">
            <div class="section-top-image"><Image src={atelierImg} alt="Atelier" width={600} height={800} /></div>
            <h2>Notre Atelier : Là où la Magie Opère</h2>
            <p>Situé à Chasseradès, au cœur de la Lozère, notre atelier est le lieu de rencontre entre la matière brute et notre savoir-faire ancestral.</p>
            <a href="/atelier" class="btn">Visiter l'Atelier</a>
        </div>
    </section>

    <section id="apropos">
        <div class="container">
            <div class="section-top-image"><Image src={aproposImg} alt="Jean-François BARON" width={600} height={669} /></div>
            <h2>À Propos de l'Artisan et Notre Histoire</h2>
            <p>Artisans passionnés, Jean François & Aniuta se consacrent au travail du bois depuis de nombreuses années. Nous privilégions les essences locales.</p>
            <a href="/apropos" class="btn">En Savoir Plus sur Nous</a> 
        </div>
    </section>
</MainLayout>