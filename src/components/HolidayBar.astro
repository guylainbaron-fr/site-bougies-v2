---
const eventsData = await Astro.glob('../data/holiday-events.json');
const events = eventsData[0].default;

const { currentPage } = Astro.props;

const showHolidayBar = true;
const now = new Date();
const currentYear = now.getFullYear();

// 1. Trouver l'événement actif
const activeEvent = events
  .filter(e => {
    // On recrée des dates complètes pour l'année en cours
    const startDate = new Date(`${currentYear}-${e.start}T00:00:00`);
    const endDate = new Date(`${currentYear}-${e.end}T23:59:59`);
    
    // Cas spécial pour Noël/Nouvel An qui chevauchent deux années (ex: 12-20 au 01-05)
    if (startDate > endDate) {
        endDate.setFullYear(currentYear + 1);
    }
    
    return now >= startDate && now <= endDate;
  })
  .sort((a, b) => {
    // Les événements plus courts (ex: anniversaire de 1 jour) restent prioritaires
    const durationA = new Date(`2000-${a.end}`).getTime() - new Date(`2000-${a.start}`).getTime();
    const durationB = new Date(`2000-${b.end}`).getTime() - new Date(`2000-${b.start}`).getTime();
    return durationA - durationB;
  })[0];

// 2. Récupérer le message spécifique à la page
let displayMessage = "";
if (activeEvent) {
    displayMessage = activeEvent.pages[currentPage] || activeEvent.pages["default"] || Object.values(activeEvent.pages)[0];
}
---

{showHolidayBar && activeEvent && displayMessage && (
    <div class="holiday-bar glow">
        <span class="holiday-text">
            <Fragment set:html={displayMessage} />
        </span>
    </div>
)}