---
// 1. On récupère le fichier
const eventsFiles = import.meta.glob('../data/holiday-events.json', { eager: true });

// 2. On extrait les données en précisant le type "any" pour éviter l'erreur TS
const eventsData = Object.values(eventsFiles)[0] as any;
const events = eventsData.default;

const { currentPage } = Astro.props;

const showHolidayBar = true;

/** * CORRECTION FUSEAU HORAIRE & ANNÉE DYNAMIQUE
 * On force l'heure de Paris pour éviter le décalage Vercel
 * et on récupère l'année pour le remplacement automatique.
 */
const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Paris" }));
const currentYear = now.getFullYear();

// 1. Trouver l'événement actif
const activeEvent = events
  .filter(e => {
    // On recrée des dates complètes basées sur l'heure française
    const startDate = new Date(`${currentYear}-${e.start}T00:00:00`);
    const endDate = new Date(`${currentYear}-${e.end}T23:59:59`);
    
    // Cas spécial pour Noël/Nouvel An qui chevauchent deux années
    if (startDate > endDate) {
        endDate.setFullYear(currentYear + 1);
    }
    
    return now >= startDate && now <= endDate;
  })
  .sort((a, b) => {
    // Priorité aux événements les plus courts (ex: anniversaire de 1 jour)
    const durationA = new Date(`2000-${a.end}`).getTime() - new Date(`2000-${a.start}`).getTime();
    const durationB = new Date(`2000-${b.end}`).getTime() - new Date(`2000-${b.start}`).getTime();
    return durationA - durationB;
  })[0];

// 2. Récupérer le message spécifique à la page
let displayMessage = "";
if (activeEvent) {
    displayMessage = activeEvent.pages[currentPage] || activeEvent.pages["default"] || Object.values(activeEvent.pages)[0];
    
    // --- REMPLACEMENT DYNAMIQUE DE L'ANNÉE ---
    // Remplace {{year}} par 2026 (ou l'année actuelle) dans le texte du JSON
    if (displayMessage && displayMessage.includes("{{year}}")) {
        displayMessage = displayMessage.replaceAll("{{year}}", currentYear.toString());
    }
}
---

{showHolidayBar && activeEvent && displayMessage && (
    <div class="holiday-bar glow">
        <span class="holiday-text">
            <Fragment set:html={displayMessage} />
        </span>
    </div>
)}